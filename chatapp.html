<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <title>Chat App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- PARSE stuff-->
    <script type="text/javascript" src="https://npmcdn.com/parse/dist/parse.min.js"></script>

    <script type="text/javascript" type="text/javascript">
        Parse.initialize("9j3JlwaGcuBfve06oFT8p1N8nckAHOJwU9CVpjA4","BOJUBKqamLFXnkkzGmzzsMUpmM4ws8sGAzcBortj"); 
        Parse.serverURL = 'https://parseapi.back4app.com/'
      </script>
    <style>
     
      @media (min-width: 768px) {
        /* some rules */
      }
    </style>

    <!-- Custom styles for this template -->
    <link href="styles/chatapp.css" rel="stylesheet">
  </head>
  <body>
    <div class="container">
    <div class="col-lg-8 mx-auto py-md-5 text-center">
        
        <h2>Chatzapp</h2>
        <p class="lead">Chat with your friends</p>
        <p id="current-user-text"></p>
        <div class="input-group mb-3">
            <input id="msg-input" type="text" class="form-control" placeholder="Enter a message" >
            <button class="btn btn-secondary" type="button" id="send-msg-btn" onclick="addMessage()">Send</button>
        </div>

    </div>
        <div class="container col-lg-8 mx-auto" id="all-messages-box" >
            <!-- The messages output here -->
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>

    <script>

      let currentUser = prompt("Please enter your name to chat:");
        if (currentUser == null || currentUser == "") {
          text = "User cancelled the prompt.";
          currentUser = "Anonymous"
        } else {
          text = `Hello ${currentUser}!`;

          document.querySelector('#current-user-text').innerHTML = currentUser

        }

        let messages = []
         

        getAllMessages()

        function addMessage(){
    
            let msgInput = document.querySelector("#msg-input") //use to get the input text
            let newMessage = `${msgInput.value}`

            msgInput.value = ""
            //messages.push(newMessage)
            storeMsg(newMessage)

            //console.log(messages)
           
        }

        async function storeMsg(msg){

            const msgToStore = new Parse.Object('Message')
            
            msgToStore.set('username', currentUser);
            msgToStore.set('msgText', msg)

            try {
                const result = await msgToStore.save();
                console.log("Successfully added " + result.id )

                appendMessge(currentUser, msg, Date.now())
               // getAllMessages() //load them all again
               

              
            } catch (error) {
                console.log(error)
            }
        }



        async function getAllMessages(){


          let allMessages = document.querySelector("#all-messages-box")
          allMessages.innerHTML = ""
          messages=[] //empty the array

          try {
            
            const query = new Parse.Query("Message");
            const results = await query.find();

             for (const msg of results) {
              const msgText = msg.get('msgText')
              const msgDate = msg.get('createdAt').toLocaleString()
              const msgUser = msg.get('username')
              let fullMsg = `${msgUser} : ${msgText} at ${msgDate}`


              let fullMessage = `<p class"user-chat">
                                <span class="username"> ${msgUser}: </span>
                                <span class="message-text"> ${msgText}</span>
                                <span class="message-date"> at ${msgDate}</span>
                                </p>`

              

              messages.push(fullMessage)
            
              }

              displayMessages()

          } catch (error) {
            console.log(error)
          }
        }

        function appendMessge(user, message, date){

          let newMessage = `<p class"user-chat">
                                <span class="username"> ${user}: </span>
                                <span class="message-text"> ${message}</span>
                                <span class="message-date"> at ${date.toLocaleString()}</span>
                                </p>`
          
          let allMessages = document.querySelector("#all-messages-box")
          allMessages.insertAdjacentHTML("beforeend", newMessage)
           

        }

       

        function displayMessages(){

          let allMessages = document.querySelector("#all-messages-box")
          allMessages.innerHTML = ""

          if (messages.length > 0){

            for ( message of messages){
              //output.insertAdjacentHTML("beforeend",user)
              allMessages.insertAdjacentHTML("beforeend",message)
              // let newParagraph = document.createElement("p")
              // newParagraph.innerText = message
              // allMessages.appendChild(newParagraph)  //use to set a value

            }
          }
        }

    </script>
      
  </body>
</html>
